(function(){const l="roster",U=["Infantry","Armored","Flying","Cavalry"],b=["Red Sword","Blue Lance","Green Axe","Colorless Staff"],u=document.getElementById("barracks"),F=document.querySelectorAll('input[name="tab"]'),L=document.getElementById("search-content"),T=document.getElementById("global-hero-search"),q=document.getElementById("barracks-search"),E=document.getElementById("skill-donors"),D=document.getElementById("skill-filters"),z=document.getElementById("export"),K=document.getElementById("import"),G=document.getElementById("clear"),k="https://api.feh-inheritance.tonion-the-onion.com";let N,v="",C=0,m="";document.getElementById("search").click(),z.onclick=Q,K.onchange=Y,G.onclick=X,q.onkeyup=Z,Array.from(document.getElementsByClassName("filter-input")).forEach(e=>{e.onclick=function(){m=this.id,R(m,N)}});for(let e of F)e.onchange=function(){const{id:t}=this,o=document.querySelectorAll(".tab-content");for(let n of o)n.id.includes(t)?n.classList.remove("hide"):n.classList.add("hide");t==="inheritables"?T.parentNode.classList.add("hide"):T.parentNode.classList.remove("hide")};T.onkeyup=e=>{v=e.target.value,(v.length>2||!v.length)&&(C=0,y(0))};for(let e of["Red","Blue","Green","Colorless"])for(let t of["Bow","Tome","Breath","Beast","Dagger"])b.push(`${e} ${t}`);localStorage.getItem(l)===null?localStorage.setItem(l,"[]"):(A(),P()),y(C);function A(){const e=JSON.parse(localStorage.getItem(l)??"[]");if(e.length){const t=new Map;for(let{id:n,...i}of e)n&&(t.get(n)||t.set(n,i));const o=[];t.forEach((n,i)=>{n.name&&o.push({id:i,...n})}),localStorage.setItem(l,JSON.stringify(o));for(let n of e){const{heroButton:i}=j(n);u.appendChild(i)}}else u.innerHTML=""}function J(e,t){return function(n){n.stopPropagation(),u.removeChild(t),y(C);const i=JSON.parse(localStorage.getItem(l)).filter(s=>+s.id!=+e);localStorage.setItem(l,JSON.stringify(i))}}function H(e,t){let o=t;return function(i){const s=!o;this.src=s?"./static/favorite-on.png":"./static/favorite-off.png",e.dataset.favorite=s.toString(),i.stopPropagation();const a=JSON.parse(localStorage.getItem(l)),r=a.find(c=>+c.id==+e.dataset.unitId),d=a.map(c=>+c.id);if(s){const c=a.find(f=>!f.favorite);if(c){const{id:f}=c,h=d.indexOf(+r.id);a.splice(h,1),a.unshift(r),e.parentNode.insertBefore(e,e.parentNode.querySelector(`[data-unit-id="${f}"]`)),r.favorite=!0,localStorage.setItem(l,JSON.stringify(a))}}else{r.favorite=!1;const c=d.indexOf(+r.id);a[c]=r,localStorage.setItem(l,JSON.stringify(a))}o=s,N=e,document.getElementById("weapon").click()}}function W(){const e=j({id:this.dataset.unitId,name:this.dataset.heroName,favorite:!1});u.appendChild(e.heroButton),e.heroButton.onclick=function(){N=this,m||(m="weapon",document.getElementById(m).checked=!0),R(m,this)};const t=JSON.parse(localStorage.getItem(l));t.push({id:this.dataset.unitId,name:this.dataset.heroName,favorite:!1}),localStorage.setItem(l,JSON.stringify(t)),L.removeChild(this)}function y(e,t){const o=JSON.parse(localStorage.getItem(l)??"[]"),n=new URLSearchParams,i=o.map(({id:s})=>(+s).toString(16)).join(",");return i.length&&n.append("ids",i),v.trim().length&&n.append("query",v),n.append("page",e),$(`/heroes?${n.toString()}`).then(s=>{t||(L.innerHTML="");for(let r of s){const[d,c,f,h]=r.split("-");console.log(r.split("-"));const{heroButton:I,iconsContainer:g}=w(d,!0,h),S=document.createElement("img"),O=b[f].replace(/ /g,"_");S.loading="lazy",S.src=`https://feheroes.fandom.com/wiki/Special:Redirect/file/Icon_Class_${O}.png`,S.alt=O,S.classList.add("top-left");const p=document.createElement("img");p.loading="lazy";const B=U[c];p.src=`https://feheroes.fandom.com/wiki/Special:Redirect/file/Icon_Move_${B}.png`,p.classList.add("bottom-right"),g.appendChild(p),g.appendChild(S),L.appendChild(I),I.onclick=W}let a=document.getElementById("load-more");if(!a){const r=document.createElement("button");r.classList.add("cta"),r.id="load-more",r.onclick=function(){C++,y(C,!0)},r.innerHTML="Load More",a=r}L.appendChild(a)})}function w(e,t,o){const n=document.createElement("button");n.classList.add("hero-container");const i=document.createElement("img");i.alt="",i.src="./static/frame.webp",i.classList.add("hero-frame");const s=document.createElement("img");s.loading="lazy",s.src=`${k}/img?id=${e}&imgType=portrait`,s.classList.add("portrait"),s.alt=o??"",n.appendChild(s),n.dataset.unitId=e,o&&(n.dataset.heroName=o);let a=null;return a=document.createElement("div"),a.classList.add("icons-container"),a.appendChild(i),t?n.appendChild(a):n.appendChild(i),{heroButton:n,iconsContainer:a}}function _(){const e=document.createElement("div");e.classList.add("delete-button");const t=document.createElement("img");return t.src="./static/trash.png",e.appendChild(t),e}function M(e){const t=document.createElement("img");return t.src=e?"./static/favorite-on.png":"./static/favorite-off.png",t.classList.add("top-left"),t}function R(e,t){const{unitId:o}=t.dataset,s=JSON.parse(localStorage.getItem(l)).filter(({favorite:a})=>!a).map(({id:a})=>(+a).toString(16));document.getElementById("inheritables").click(),$(`/skills?slot=${e}&searchedId=${o}&ids=${s.join(",")}`).then(a=>{E.innerHTML="";const r=document.getElementById("upgrade-heading");D.classList.remove("hide"),r.innerHTML=`Skills that ${a.searched} can inherit`,r.classList.add("target-banner");let d=document.getElementById("target-portrait");if(d||(d=document.createElement("img"),d.id="target-portrait",d.loading="lazy",r.appendChild(d)),d.alt="",d.src=`${k}/img?id=${o}&imgType=battle`,!Object.keys(a.Skills).length){const c=document.createElement("div");c.classList.add("donor-banner"),c.innerHTML=`There are no units that could give any ${e} in the current roster.`,E.appendChild(c);return}for(let c in a.Skills){const f=a.Skills[c],h=document.createElement("h3");h.classList.add("skill-subtitle"),h.innerHTML=c;const I=document.createElement("div");I.classList.add("skill-title");const g=document.createElement("img");g.classList.add("skill-icon"),g.loading="lazy",["weapon","assist","special"].includes(e)?g.src=`./static/${e}-icon.png`:g.src=`https://feheroes.fandom.com/wiki/Special:Redirect/file/${f.icon}.png`,I.appendChild(g),E.appendChild(h),I.appendChild(h),E.appendChild(I);for(let S of f.ids){const O=a.units[S],p=document.createElement("div");p.classList.add("donor-banner"),p.innerText=O.replace(":",": ");const B=document.createElement("img");B.loading="lazy",B.src=`${k}/img?id=${S}&imgType=battle`,B.classList.add("skill-donor"),p.appendChild(B),E.appendChild(p)}}})}function Y(){const[e]=this.files,t=new FileReader;t.onerror=function(){alert("An error happened, please try again.")},t.onloadend=({target:o})=>{const{result:n}=o;try{const i=JSON.parse(n);if(i.find(a=>typeof a!="object"||!a.id||!("favorite"in a)))throw new Error;u.innerHTML="";for(let a of i){const r=w(a.id,!0),d=M(a.favorite),c=_();r.heroButton.dataset.favorite=a.favorite,r.iconsContainer.appendChild(d),r.iconsContainer.appendChild(c),d.onclick=H(r.heroButton,!1),c.onclick=J(r.heroButton.dataset.unitId,r.heroButton),u.appendChild(r.heroButton)}localStorage.setItem(l,JSON.stringify(i)),P(),y(0)}catch{alert("There was an error parsing your file. Please try with another one.")}},t.readAsText(e)}function Q(){const e=JSON.parse(localStorage.getItem(l)),t=JSON.stringify(e),o=document.createElement("a");o.style.display="none",document.body.appendChild(o),o.download="feh-roster.json";const n=new Blob([t],{type:"text/json"}),i=URL.createObjectURL(n);o.href=i,o.click(),document.body.removeChild(o)}function x(){const e=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${e}px`)}window.addEventListener("load",x),window.addEventListener("resize",x);function P(){const e=JSON.parse(localStorage.getItem(l)).filter(t=>!t.name);if(e.length){const t=V(e,({id:o})=>o);$(`/names?ids=${t.join(",")}`).then(o=>{for(let n=0;n<o.length;n++)e[n].name=o[n];localStorage.setItem(l,JSON.stringify(e))})}}async function $(e){const t=new AbortController;return fetch(`${k}${e}`,{signal:t.signal}).catch(()=>{}).then(o=>o.json())}function V(e,t){return e.map(t).map(o=>(+o).toString(16))}function X(){localStorage.clear(),A(),y(0)}function Z(e){const t=e.target.value.toLowerCase();if(t==="")Array.from(u.children).forEach(o=>o.classList.remove("hide"));else if(t.length>=2){const o=JSON.parse(localStorage.getItem(l)??"[]");for(let n=0;n<o.length;n++){const i=o[n],s=i.id;i.name.toLowerCase().startsWith(t)?u.querySelector(`[data-unit-id="${s}"]`).classList.remove("hide"):u.querySelector(`[data-unit-id="${s}"]`).classList.add("hide")}}}function j(e){const t=w(e.id,!0,e.name),o=M(e.favorite),n=_();return t.heroButton.dataset.favorite=e.favorite,t.heroButton.dataset.unitId=e.id,t.heroButton.dataset.heroName=e.name,t.heroButton.onclick=function(){N=this,m||(m="weapon",document.getElementById(m).checked=!0),R(m,this)},o.onclick=H(t.heroButton,e.favorite),n.onclick=J(t.heroButton.dataset.unitId,t.heroButton),t.iconsContainer.appendChild(o),t.iconsContainer.appendChild(n),t}})();
